<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Termtrainer â€“ Multiplikation mit Levelsystem</title>
<style>
  body {
    font-family: system-ui, Arial, sans-serif;
    background: linear-gradient(to bottom right,#f0f4ff,#e0f7fa);
    text-align: center;
    margin: 0;
    padding: 20px;
  }
  h1 { color:#333; margin:10px 0; font-size:1.8em; }
  #task { font-size:1.6em; margin:15px auto; white-space:pre-line; }
  #result { font-size:1.1em; margin:10px; color:#000; font-weight:400; }
  #score { font-size:1.1em; margin:8px; color:#333; }
  #levelDisplay { font-weight:bold; color:#007bff; margin-bottom:5px; }
  #progressContainer {
    width:80%; max-width:400px; height:20px;
    background-color:#ddd; border-radius:10px;
    margin:10px auto 20px; overflow:hidden;
    display:flex;
  }
  .progress-segment {
    height:100%;
    flex:1;
    transition:background-color 0.3s ease;
  }
  input {
    padding:10px; font-size:1.2em; width:80%; max-width:300px;
    text-align:center; border-radius:8px; border:1px solid #aaa;
  }
  input:focus { outline:none; border-color:#007bff; }
  button {
    background:#007bff; color:white; border:none;
    padding:10px 18px; margin:6px; font-size:1em;
    border-radius:8px; cursor:pointer;
  }
  button:hover { background:#0056b3; }
  details summary { cursor:pointer; color:#007bff; margin-top:8px; }
  details summary:hover { text-decoration:underline; }
</style>
</head>
<body>
<h1>Termtrainer â€“ Multiplikation</h1>
<div id="levelDisplay">Level 1: Ganze Zahlen</div>
<div id="score">Lade...</div>
<div id="progressContainer"></div>
<div id="task">...</div>
<input type="text" id="answer" placeholder="Deine LÃ¶sung" autocomplete="off" spellcheck="false"><br>
<button id="checkBtn">PrÃ¼fen</button>
<button id="newBtn">Neue Aufgabe</button>
<p id="result"></p>
<p style="font-size:0.8em;color:#555;margin-top:40px;">
Diese Seite speichert keine persÃ¶nlichen Daten und lÃ¤uft vollstÃ¤ndig lokal im Browser.<br>
Â© 2025 Termtrainer mit Levelsystem
</p>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const answerEl = document.getElementById("answer");
  const checkBtn = document.getElementById("checkBtn");
  const newBtn = document.getElementById("newBtn");
  const taskEl = document.getElementById("task");
  const resultEl = document.getElementById("result");
  const scoreEl = document.getElementById("score");
  const levelDisplay = document.getElementById("levelDisplay");
  const progressContainer = document.getElementById("progressContainer");

  const COEFFS=[2,3,4,5,6,7,8,9];
  const VARS=['a','b','m','n','p','q','x','y'];
  const randomChoice=a=>a[Math.floor(Math.random()*a.length)];
  const randomSign=()=>Math.random()<0.5?'-':'+';
  const randomCoeff=()=>randomChoice(COEFFS);
  const randomVar=()=>randomChoice(VARS);
  const formatCoeff=(n,isVar)=>{if(!isVar)return String(n);if(n===1)return"";if(n===-1)return"-";return String(n);};
  const normMul=s=>s.replace(/\s+/g,'').replace(/^(\+)?/,'').replace(/Â²/g,'^2').replace(/Â³/g,'^3').replace(/âˆ’/g,'-').toLowerCase();

  // Alphabetische Sortierung + gleiche Variablen zu Potenzen zusammenfassen
  function sortVars(term) {
    const normalized = String(term)
      .replace(/\s+/g, '')
      .replace(/Â²/g, '^2')
      .replace(/Â³/g, '^3');

    const matches = [...normalized.matchAll(/([a-z])(?:\^(\d+))?/g)];
    const counts = {};
    for (const [, v, exp] of matches) {
      counts[v] = (counts[v] || 0) + (exp ? parseInt(exp, 10) : 1);
    }

    return Object.keys(counts).sort().map(v => {
      const k = counts[v];
      if (k === 1) return v;
      if (k === 2) return v + 'Â²';
      if (k === 3) return v + 'Â³';
      return v + '^' + k; // Fallback ab 4
    }).join('');
  }

  let level=1, correctSolution="", round=1, score=0, totalRounds=10;
  let firstTry=true, answered=false;
  const segments=[];

  // Fortschrittsbalken initialisieren
  function initProgressBar(){
    progressContainer.innerHTML="";
    segments.length=0;
    for(let i=0;i<totalRounds;i++){
      const seg=document.createElement("div");
      seg.className="progress-segment";
      seg.style.backgroundColor="#ddd";
      progressContainer.appendChild(seg);
      segments.push(seg);
    }
  }

  const LEVEL_NAMES=[
    "Level 1: Ganze Zahlen",
    "Level 2: Monome",
    "Level 3: Monom Â· Binom",
    "Level 4: Binom Â· Binom",
    "Level 5: Gemischt"
  ];

  // --- Aufgabenfunktionen ---
  function createIntTask(){
    const count=Math.random()<0.5?2:3;
    let nums=[], res=1;
    for(let i=0;i<count;i++){
      const max=(count===3)?5:9;
      let n=Math.floor(Math.random()*(max*2+1))-max;
      if(n===0)n=1;
      nums.push(n); res*=n;
    }
    correctSolution=String(res);
    return nums.map(n=>{
      const plusForm=Math.random()<0.75;
      if(n>0 && plusForm)return`(+${n})`;
      if(n<0)return`(${n})`;
      return`${n}`;
    }).join(" Â· ")+" = ?";
  }

  function createSimpleTask(){
  const count = Math.random() < 0.5 ? 2 : 3;
  let coeff = 1, vars = [];
  let text = "";

  // HÃ¤ufig gleiche Variablen
  const sameVarChance = Math.random() < 0.8;
  const baseVar = randomVar();

  for (let i = 0; i < count; i++) {
    const s = randomSign() === '-' ? -1 : 1;
    const max = (count === 3) ? 3 : 9;
    const n = randomChoice([...Array(max).keys()].map(x => x + 1));

    // In 90 % der FÃ¤lle mit Variable
    const hasVar = Math.random() < 0.9;
    const v = hasVar ? (sameVarChance ? baseVar : randomVar()) : "";

    coeff *= s * n;
    if (hasVar) vars.push(v);

    // Darstellung: 1x â†’ x, âˆ’1x â†’ âˆ’x, aber 2x bleibt 2x
    let numPart = (n === 1 ? "" : n);
    if (s === -1) numPart = (n === 1 ? "-" : "-" + n);

    const plusForm = (s === 1 && Math.random() < 0.75);
    const inner = plusForm ? `(+${numPart}${v})` : `(${numPart}${v})`;
    text += inner + " Â· ";
  }

  text = text.slice(0, -3);

  // Variablen zusammenfassen
  vars.sort();
  const varCount = {};
  for (const v of vars) varCount[v] = (varCount[v] || 0) + 1;

  let varsPart = "";
  for (const [v, exp] of Object.entries(varCount))
    varsPart += v + (exp > 1 ? (exp === 2 ? 'Â²' : 'Â³') : '');
  varsPart = sortVars(varsPart);

  correctSolution = `${formatCoeff(coeff, true)}${varsPart}`;
  return `${text} = ?`;
}


  function createMonomBinom() {
    const coeff = randomCoeff() * (Math.random() < 0.5 ? -1 : 1);
    const v1 = randomVar();
    const exp1 = Math.floor(Math.random() * 3) + 1;
    const monom = `${formatCoeff(coeff, true)}${v1}${exp1 > 1 ? (exp1 === 2 ? 'Â²' : 'Â³') : ''}`;

    let v2 = randomVar();
    if (v2 === v1 && exp1 >= 2) {
      do { v2 = randomVar(); } while (v2 === v1);
    }

    const b1 = randomCoeff() * (Math.random() < 0.5 ? -1 : 1);
    const b2 = randomCoeff() * (Math.random() < 0.5 ? -1 : 1);

    const binom = `(${b1 >= 0 ? '+':''}${b1}${v2} ${b2 >= 0 ? '+':'-'} ${Math.abs(b2)})`;

    const expPart = exp1 > 1 ? (exp1 === 2 ? 'Â²' : 'Â³') : '';
    let vars1 = sortVars(v1 + expPart + v2);
    let vars2 = sortVars(v1 + expPart);

    if (vars1.includes(v1 + 'â´') || vars1.includes(v1 + '^4')) {
      return createMonomBinom();
    }

    const term1 = `${coeff * b1}${vars1}`;
    const term2 = `${coeff * b2}${vars2}`;
    correctSolution = `${term1.startsWith('-') ? '' : '+'}${term1} ${term2.startsWith('-') ? '' : '+'} ${term2}`
      .replace(/\+\s*-/g, '- ')
      .replace(/^\+\s*/, '');

    return `${monom} Â· ${binom} = ?`;
  }

  function createGeneralBinom(){
    let v1=randomVar(),v2=randomVar();
    if(Math.random()<0.5)v2=v1;
    const a1=randomCoeff(),a2=randomCoeff(),b=randomCoeff(),c=randomCoeff();
    const s1=randomSign(),s2=randomSign();
    const sb=s1==='+'?1:-1,sc=s2==='+'?1:-1;
    const sameVar=v1===v2;
    let sol="";
    if(sameVar){
      const a2v2=a1*a2;
      const xCoeff=(a1*sc*c)+(a2*sb*b);
      const bc=sb*sc*b*c;
      sol=`${formatCoeff(a2v2,true)}${v1}Â²`;
      if(xCoeff>0)sol+=` + ${formatCoeff(xCoeff,true)}${v1}`;
      else if(xCoeff<0)sol+=` - ${formatCoeff(Math.abs(xCoeff),true)}${v1}`;
      if(bc>0)sol+=` + ${bc}`; else if(bc<0)sol+=` - ${Math.abs(bc)}`;
    }else{
      const a1a2=a1*a2,ab=a1*sc*c,ac=a2*sb*b,bc=sb*sc*b*c;
      sol=`${formatCoeff(a1a2,true)}${sortVars(v1+v2)}`;
      if(ab>0)sol+=` + ${formatCoeff(ab,true)}${sortVars(v1)}`;
      else if(ab<0)sol+=` - ${formatCoeff(Math.abs(ab),true)}${sortVars(v1)}`;
      if(ac>0)sol+=` + ${formatCoeff(ac,true)}${sortVars(v2)}`;
      else if(ac<0)sol+=` - ${formatCoeff(Math.abs(ac),true)}${sortVars(v2)}`;
      if(bc>0)sol+=` + ${bc}`; else if(bc<0)sol+=` - ${Math.abs(bc)}`;
    }
    sol=sol.replace(/([a-z]{2,})/g,m=>sortVars(m));
    correctSolution=sol;
    return `(${a1}${v1} ${s1} ${b}) Â· (${a2}${v2} ${s2} ${c}) = ?`;
  }

  function createPlusMinusBinom(){
    const v=randomVar(),a=randomCoeff(),b=randomCoeff();
    correctSolution=`${formatCoeff(a*a,true)}${v}Â² - ${b*b}`;
    return `(${a}${v} + ${b}) Â· (${a}${v} - ${b}) = ?`;
  }

  const explanations = {
    1:{steps:["<b>1. Vorzeichen bestimmen:</b>","   gleiche Vorzeichen â†’ +","   verschiedene Vorzeichen â†’ âˆ’","<b>2. Zahlen multiplizieren</b>"],
      example:`3 Â· 2 = 6<br><b>Beispiel mit 3 Faktoren:</b><br>(âˆ’2) Â· (âˆ’4) Â· (3)<br>= (+8) Â· (3)<br>= +24`},
    2:{steps:["<b>1. Vorzeichen bestimmen:</b>","   gleiche Vorzeichen â†’ +","   verschiedene Vorzeichen â†’ âˆ’","<b>2. Zahlen multiplizieren</b>","<b>3. Variablen anhÃ¤ngen (xÂ·x = xÂ²)</b>"],
      example:"(âˆ’3x) Â· (2x) = âˆ’6xÂ²"},
    3:{steps:["<b>1. Vorzeichen beachten:</b>","   gleiche â†’ +","   verschiedene â†’ âˆ’","<b>2. Monom mit jedem Glied der Klammer multiplizieren</b>"],
      example:"3x Â· (x + 2) = 3xÂ² + 6x"},
    4:{steps:["<b>1. Vorzeichen beachten:</b>","   gleiche â†’ +","   verschiedene â†’ âˆ’","<b>2. Jeden Term der ersten Klammer mit jedem der zweiten multiplizieren</b>"],
      example:"(x + 2)(x + 3) = xÂ² + 5x + 6"},
    5:{steps:["<b>1. Erkennen, welche Regel passt:</b>","   gleiche â†’ +","   verschiedene â†’ âˆ’","<b>2. Passendes Verfahren anwenden</b>"],
      example:"(2x + 1)(x âˆ’ 4) = 2xÂ² âˆ’ 7x âˆ’ 4"}
  };

  function nextLevel(){
    if(score>=8 && level<4){level++;alert(`ğŸ¯ Level ${level-1} geschafft! Weiter mit ${LEVEL_NAMES[level-1]}.`);}
    else if(score>=8 && level===4){level=5;alert("ğŸ† Alle Level geschafft! Jetzt kommt das gemischte Level.");}
    else{alert(`Level ${level} beendet mit ${score}/${totalRounds} Punkten. Versuch es nochmal!`);}
    round=1;score=0;segments.forEach(s=>s.style.backgroundColor="#ddd");newTask();
  }

  function newTask(){
    resultEl.innerText="";answerEl.value="";firstTry=true;answered=false;
    levelDisplay.innerText=LEVEL_NAMES[level-1];
    if(round>totalRounds){
      resultEl.style.color="green";
      resultEl.innerHTML=`ğŸ‰ Level fertig!<br>Endstand: ${score}/${totalRounds}`;
      nextLevel();return;
    }
    let aufgabe;
    switch(level){
      case 1: aufgabe=createIntTask();break;
      case 2: aufgabe=createSimpleTask();break;
      case 3: aufgabe=createMonomBinom();break;
      case 4: aufgabe=Math.random()<0.5?createGeneralBinom():createPlusMinusBinom();break;
      case 5: aufgabe=randomChoice([createIntTask,createSimpleTask,createMonomBinom,createGeneralBinom,createPlusMinusBinom])();break;
    }
    taskEl.innerText=aufgabe;
    scoreEl.innerText=`Aufgabe ${round} von ${totalRounds} â€“ Punkte: ${score}`;
  }

  function checkAnswer(){
    const input=answerEl.value.trim();
    if(!input){resultEl.style.color="#555";resultEl.innerText="Bitte gib eine LÃ¶sung ein.";return;}
    answerEl.blur();

    if(answered){
      if(normMul(input)===normMul(correctSolution)){
        resultEl.style.color="green";
        resultEl.innerText="âœ… Richtig â€“ aber kein Punkt mehr";
      }else{
        resultEl.style.color="#000";
        resultEl.innerHTML=`âŒ Falsch! Richtige LÃ¶sung: <b>${correctSolution}</b>`;
      }
      return;
    }

    answered=true;

    if(normMul(input)===normMul(correctSolution)){
      resultEl.style.color="green";
      if(firstTry){resultEl.innerText="âœ… Richtig! (+1 Punkt)";score++;}
      else{resultEl.innerText="âœ… Richtig â€“ aber kein Punkt mehr";}
      segments[round-1].style.backgroundColor="#4caf50";
    }else{
      resultEl.style.color="#000";
      segments[round-1].style.backgroundColor="#d9534f";
      const exp=explanations[level];
      let html=`<span style="color:#d00;">âŒ Falsch!</span> Richtige LÃ¶sung: <b>${correctSolution}</b><br>`;
      if(exp){
        html+=`<details open><summary style="color:#007bff;cursor:pointer;">ğŸ§© LÃ¶sungsweg anzeigen</summary>`;
        html+=`<div style="text-align:left;max-width:420px;margin:6px auto;font-size:0.95em;line-height:1.4;color:#000;">`;
        html+=exp.steps.map(s=>`<div>${s}</div>`).join("");
        html+=`<div style="margin-top:6px;font-style:italic;">Beispiel: ${exp.example}</div></div></details>`;
      }
      resultEl.innerHTML=html;
    }

    firstTry=false;
    round++;
    scoreEl.innerText=`Aufgabe ${Math.min(round,totalRounds)} von ${totalRounds} â€“ Punkte: ${score}`;
  }

  checkBtn.addEventListener("click",checkAnswer);
  newBtn.addEventListener("click",newTask);
  answerEl.addEventListener("keydown",e=>{if(e.key==="Enter")checkAnswer();});
  initProgressBar();
  newTask();
});
</script>
</body>
</html>
