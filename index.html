<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
<title>Termtrainer â€“ Multiplikation mit Levelsystem</title>
<style>
  html, body {
    height: 100%;
    overflow-x: hidden;
  }
  body {
    font-family: system-ui, Arial, sans-serif;
    background: linear-gradient(to bottom right,#f0f4ff,#e0f7fa);
    text-align: center;
    margin: 0;
    padding: 20px;
    scroll-behavior: smooth;
  }
  h1,h2 {
    color:#333;
    margin:10px 0;
    font-size:1.6em;
    font-weight:600;
  }
  #task { font-size:1.6em; margin:15px auto; white-space:pre-line; }
  #result { font-size:1.2em; margin:10px; font-weight:bold; }
  #score { font-size:1.1em; margin:8px; color:#333; }
  #levelDisplay {
    font-weight: bold;
    color: #007bff;
    margin-bottom: 5px;
  }
  /* Fortschrittsbalken */
  #progressContainer {
    width: 80%;
    max-width: 400px;
    height: 20px;
    background-color: #ddd;
    border-radius: 10px;
    margin: 10px auto 20px;
    overflow: hidden;
  }
  #progressBar {
    height: 100%;
    width: 0%;
    background-color: #4caf50;
    transition: width 0.3s ease;
  }

  input {
    padding:10px;
    font-size:1.2em;
    width:80%;
    max-width:300px;
    text-align:center;
    border-radius:8px;
    border:1px solid #aaa;
  }
  input:focus { outline:none; border-color:#007bff; }
  button {
    background:#007bff;
    color:white;
    border:none;
    padding:10px 18px;
    margin:6px;
    font-size:1em;
    border-radius:8px;
    cursor:pointer;
  }
  button:hover { background:#0056b3; }
  .shortcutButtons { margin-top:8px; }
  .shortcutButtons button {
    background:#e3e3e3;
    color:#000;
    border:1px solid #bbb;
    padding:6px 10px;
    font-size:1.1em;
  }
  .shortcutButtons button:hover { background:#ccc; }
  @media (min-width:700px){.shortcutButtons{display:none;}}
  @media (max-width:700px){
    .shortcutButtons button{padding:8px 14px;font-size:1.3em;}
  }
</style>
</head>
<body>
<h1>Termtrainer â€“ Multiplikation</h1>
<div id="levelDisplay">Level 1: Ganze Zahlen</div>
<div id="score">Lade...</div>

<!-- Fortschrittsbalken -->
<div id="progressContainer"><div id="progressBar"></div></div>

<div id="task">...</div>
<input type="text" id="answer" placeholder="Deine LÃ¶sung" autocomplete="off" spellcheck="false"><br>
<div class="shortcutButtons">
  <button type="button" onclick="insertSymbol('Â²')">Â²</button>
  <button type="button" onclick="insertSymbol('Â³')">Â³</button>
</div>
<button id="checkBtn">PrÃ¼fen</button>
<button id="newBtn">Neue Aufgabe</button>
<p id="result"></p>

<p style="font-size:0.8em;color:#555;margin-top:40px;">
Diese Seite speichert keine persÃ¶nlichen Daten und lÃ¤uft vollstÃ¤ndig lokal im Browser.<br>
Â© 2025 Termtrainer mit Levelsystem
</p>

<script>
document.addEventListener("DOMContentLoaded",()=>{

  const answerEl=document.getElementById("answer");
  const checkBtn=document.getElementById("checkBtn");
  const newBtn=document.getElementById("newBtn");
  const taskEl=document.getElementById("task");
  const resultEl=document.getElementById("result");
  const scoreEl=document.getElementById("score");
  const levelDisplay=document.getElementById("levelDisplay");
  const progressBar=document.getElementById("progressBar");

  let lastFocusedInput=answerEl;
  answerEl.addEventListener("focus",()=>{lastFocusedInput=answerEl;});

  window.insertSymbol=function(symbol){
    const target=lastFocusedInput||answerEl;
    target.focus();
    const start=target.selectionStart??target.value.length;
    const end=target.selectionEnd??target.value.length;
    const text=target.value;
    target.value=text.slice(0,start)+symbol+text.slice(end);
    const pos=start+symbol.length;
    requestAnimationFrame(()=>{target.selectionStart=target.selectionEnd=pos;});
  };

  // Zufallshilfen
  const COEFFS=[2,3,4,5,6,7,8,9];
  const VARS=['a','b','m','n','p','q','x','y'];
  const randomChoice=a=>a[Math.floor(Math.random()*a.length)];
  const randomSign=()=>Math.random()<0.5?'-':'+';
  const randomCoeff=()=>randomChoice(COEFFS);
  const randomVar=()=>randomChoice(VARS);
  const sortVars=(v1,v2)=>[v1,v2].sort().join('');
  const formatCoeff=(n,isVar)=>{if(!isVar)return String(n);if(n===1)return"";if(n===-1)return"-";return String(n);};
  const normMul=s=>s.replace(/\s+/g,'').replace(/^(\+)?/,'').replace(/Â²/g,'^2').replace(/âˆ’/g,'-').toLowerCase();

  // Levelsystem
  let level=1;
  let correctSolution="";
  let round=1,score=0,totalRounds=10;
  const LEVEL_NAMES=[
    "Level 1: Ganze Zahlen",
    "Level 2: Monome",
    "Level 3: Monom Â· Binom",
    "Level 4: Binom Â· Binom",
    "Level 5: Gemischt"
  ];

  // Aufgabenfunktionen
  function createIntTask(){
    const a=Math.floor(Math.random()*11)-5;
    const b=Math.floor(Math.random()*11)-5;
    correctSolution=String(a*b);
    return `(${a}) Â· (${b}) = ?`;
  }
  function createSimpleTask(){
    const s1=randomSign(),s2=randomSign();
    const n1=randomCoeff(),n2=randomCoeff();
    let v1=randomVar(),v2=randomVar();
    if(Math.random()<0.5)v2=v1; else while(v2===v1)v2=randomVar();
    const aufgabe=`(${s1}${n1}${v1}) Â· (${s2}${n2}${v2}) = ?`;
    const sign=(s1===s2)?'+':'-';
    let coeff=(sign==='-')?-n1*n2:n1*n2;
    correctSolution=(v1===v2)?
      `${formatCoeff(coeff,true)}${v1}Â²`:
      `${formatCoeff(coeff,true)}${sortVars(v1,v2)}`;
    return aufgabe;
  }
  function createMonomBinom(){
    const coeff=randomCoeff();
    const v=randomVar();
    const b1=randomCoeff();
    const s1=randomSign();
    const b=s1==='+'?b1:-b1;
    correctSolution=`${formatCoeff(coeff,true)}${v}Â² ${b>=0?'+':'-'} ${Math.abs(coeff*b)}${v}`;
    return `${coeff}${v} Â· (${v} ${s1} ${Math.abs(b1)}) = ?`;
  }
  function createGeneralBinom(){
    let v1=randomVar(),v2=randomVar();
    if(Math.random()<0.5)v2=v1;
    const a1=randomCoeff();
    let a2=randomCoeff();
    if(Math.random()<0.5)a2=a1;
    const b=randomCoeff(),c=randomCoeff();
    const s1=randomSign(),s2=randomSign();
    const sb=s1==='+'?1:-1,sc=s2==='+'?1:-1;
    const sameVar=v1===v2;
    let sol="";
    if(sameVar){
      const a2v2=a1*a2;
      const xCoeff=(a1*sc*c)+(a2*sb*b);
      const bc=sb*sc*b*c;
      sol=`${formatCoeff(a2v2,true)}${v1}Â²`;
      if(xCoeff>0)sol+=` + ${formatCoeff(xCoeff,true)}${v1}`;
      else if(xCoeff<0)sol+=` - ${formatCoeff(Math.abs(xCoeff),true)}${v1}`;
      if(bc>0)sol+=` + ${bc}`; else if(bc<0)sol+=` - ${Math.abs(bc)}`;
    } else {
      const a1a2=a1*a2,ab=a1*sc*c,ac=a2*sb*b,bc=sb*sc*b*c;
      sol=`${formatCoeff(a1a2,true)}${sortVars(v1,v2)}`;
      if(ab>0)sol+=` + ${formatCoeff(ab,true)}${v1}`;
      else if(ab<0)sol+=` - ${formatCoeff(Math.abs(ab),true)}${v1}`;
      if(ac>0)sol+=` + ${formatCoeff(ac,true)}${v2}`;
      else if(ac<0)sol+=` - ${formatCoeff(Math.abs(ac),true)}${v2}`;
      if(bc>0)sol+=` + ${bc}`; else if(bc<0)sol+=` - ${Math.abs(bc)}`;
    }
    correctSolution=sol;
    return `(${a1}${v1} ${s1} ${b}) Â· (${a2}${v2} ${s2} ${c}) = ?`;
  }
  function createPlusMinusBinom(){
    const v=randomVar(),a=randomCoeff(),b=randomCoeff();
    correctSolution=`${formatCoeff(a*a,true)}${v}Â² - ${b*b}`;
    return `(${a}${v} + ${b}) Â· (${a}${v} - ${b}) = ?`;
  }

  const explanations={
    1:"Multipliziere einfach die beiden Zahlen.\nBeispiel: (âˆ’3)Â·(âˆ’2)=+6, da Minus mal Minus Plus ergibt.",
    2:"Multipliziere die Vorzeichen und Zahlen, hÃ¤nge die Variablen aneinander.\nBeispiel: (âˆ’3x)Â·(2y)=âˆ’6xy.",
    3:"Verteile das Monom auf beide Glieder des Binoms: a(b+c)=ab+ac.",
    4:"Multipliziere jeden Term der ersten Klammer mit jedem Term der zweiten:\n(a+b)(c+d)=ac+ad+bc+bd."
  };

  function nextLevel(){
    if(level<4 && score>=8){
      level++;
      alert(`ðŸŽ¯ Level geschafft! ${LEVEL_NAMES[level-1]} beginnt jetzt.`);
      round=1;score=0;
    } else if(level===4 && score>=8){
      level=5;
      alert("ðŸ† Super! Du hast alle Level geschafft. Jetzt kommen gemischte Aufgaben!");
      round=1;score=0;
    }
  }

  function updateProgress(){
    const percent=((round-1)/totalRounds)*100;
    progressBar.style.width=percent+"%";
  }

  function newTask(){
    resultEl.innerText="";
    answerEl.value="";
    updateProgress();
    levelDisplay.innerText=LEVEL_NAMES[level-1];
    if(round>totalRounds){
      taskEl.innerText="ðŸŽ‰ Level fertig!";
      resultEl.style.color="green";
      resultEl.innerText=`Endstand: ${score}/${totalRounds} Punkte.`;
      newBtn.textContent="Weiter";
      nextLevel();
      updateProgress();
      return;
    }
    let aufgabe;
    switch(level){
      case 1: aufgabe=createIntTask(); break;
      case 2: aufgabe=createSimpleTask(); break;
      case 3: aufgabe=createMonomBinom(); break;
      case 4: aufgabe=Math.random()<0.5?createGeneralBinom():createPlusMinusBinom(); break;
      case 5:{
        const funcs=[createIntTask,createSimpleTask,createMonomBinom,createGeneralBinom,createPlusMinusBinom];
        aufgabe=randomChoice(funcs)(); break;
      }
    }
    taskEl.innerText=`${LEVEL_NAMES[level-1]}\n${aufgabe}`;
    scoreEl.innerText=`Aufgabe ${round} von ${totalRounds} â€“ Punkte: ${score}`;
  }

   let firstTry = true; // NEU: merkt, ob erste Eingabe noch unversucht ist

  function newTask(){
    resultEl.innerText="";
    answerEl.value="";
    firstTry = true; // bei neuer Aufgabe wieder auf "erster Versuch" setzen
    updateProgress();
    levelDisplay.innerText=LEVEL_NAMES[level-1];
    if(round>totalRounds){
      taskEl.innerText="ðŸŽ‰ Level fertig!";
      resultEl.style.color="green";
      resultEl.innerText=`Endstand: ${score}/${totalRounds} Punkte.`;
      newBtn.textContent="Weiter";
      nextLevel();
      updateProgress();
      return;
    }
    let aufgabe;
    switch(level){
      case 1: aufgabe=createIntTask(); break;
      case 2: aufgabe=createSimpleTask(); break;
      case 3: aufgabe=createMonomBinom(); break;
      case 4: aufgabe=Math.random()<0.5?createGeneralBinom():createPlusMinusBinom(); break;
      case 5:{
        const funcs=[createIntTask,createSimpleTask,createMonomBinom,createGeneralBinom,createPlusMinusBinom];
        aufgabe=randomChoice(funcs)(); break;
      }
    }
    taskEl.innerText=`${LEVEL_NAMES[level-1]}\n${aufgabe}`;
    scoreEl.innerText=`Aufgabe ${round} von ${totalRounds} â€“ Punkte: ${score}`;
  }

  function checkAnswer(){
    const input=answerEl.value.trim();
    if(!input){
      resultEl.style.color="gray";
      resultEl.innerText="Bitte gib eine LÃ¶sung ein.";return;
    }
    answerEl.blur();

    if(normMul(input)===normMul(correctSolution)){
      resultEl.style.color="green";
      if(firstTry){
        resultEl.innerText="âœ… Richtig! (+1 Punkt)";
        score++;
      } else {
        resultEl.innerText="âœ… Richtig â€“ aber kein Punkt mehr (zweiter Versuch)";
      }
      firstTry = false; // Punktvergabe erfolgt nur einmal
    } else {
      resultEl.style.color="red";
      resultEl.innerHTML=`âŒ Falsch! Richtige LÃ¶sung: ${correctSolution}<br><small>${explanations[level]||""}</small>`;
      firstTry = false; // danach keine Punkte mehr mÃ¶glich
    }

    // Runde erst nach richtiger LÃ¶sung fortsetzen
    if(normMul(input)===normMul(correctSolution)){
      round++;
      updateProgress();
      scoreEl.innerText=`Aufgabe ${Math.min(round,totalRounds)} von ${totalRounds} â€“ Punkte: ${score}`;
    }
  }

  checkBtn.addEventListener("click",checkAnswer);
  newBtn.addEventListener("click",newTask);
  answerEl.addEventListener("keydown",e=>{if(e.key==="Enter")checkAnswer();});

  newTask();
});
</script>
</body>
</html>
